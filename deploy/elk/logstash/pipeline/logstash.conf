input {
  file {
    path => "/usr/share/logstash/nginx/access.log"
    start_position => "beginning"
    sincedb_path   => "/usr/share/logstash/data/.sincedb_nginx_access"
  }
}

filter {
  grok {
    match => { "message" => "%{COMBINEDAPACHELOG}" }
    remove_field   => ["message"]
    tag_on_failure => ["_grok_nginx_access_fail"]
  }
  date {
    match        => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    target       => "@timestamp"
    remove_field => ["timestamp"]
  }
  mutate { add_field => { "event.dataset" => "nginx.access" } }
}

output {
  elasticsearch {
    hosts    => ["${ELASTIC_URL}"]
    user     => "${ELASTIC_USER}"
    password => "${ELASTIC_PASSWORD}"
    ssl_enabled => true 
    ssl_certificate_authorities => ["/usr/share/logstash/config/certs/ca/ca.crt"]
    index    => "logstash-%{+YYYY.MM.dd}"
  }
  stdout { codec => rubydebug }
}
